---
title: "July 2019 TWAU Shokunin"
author: "Kevin Yeung"
date: "21/07/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

I use the ```jpeg``` library to read in the RGB values of each image. The image is then divided into different regions. In each region, the RGB value of the centre 4x4 square is taken as a feature.

For each city, its images are split into training and validation sets (80:20).

```{r function-definitions}
#install.packages("jpeg")
#install.packages("dplyr")
#install.packages("party")
library(jpeg)
library(dplyr)
library(party)
library(randomForest)

getPixelValues <- function(pixels) {
  c(pixels[3:6,7:10], pixels[3:6,24:27], pixels[3:6,39:42], pixels[3:6,54:57],
    pixels[11:14,7:10], pixels[11:14,24:27], pixels[11:14,39:42], pixels[11:14,54:57],
    pixels[19:22,7:10], pixels[19:22,24:27], pixels[19:22,39:42], pixels[19:22,54:57],
    pixels[27:30,7:10], pixels[27:30,24:27], pixels[27:30,39:42], pixels[27:30,54:57])
}

getR <- function(img) {
  getPixelValues(img[,,1])
}
getG <- function(img) {
  getPixelValues(img[,,2])
}
getB <- function(img) {
  getPixelValues(img[,,3])
}

getImageFeatures <- function(label, img) {
  r <- getR(img)
  g <- getG(img)
  b <- getB(img)
  df <- data.frame(t(c(r,g,b)))
  cbind("city" = label, df)
}

extractAndLabelImages <- function(label) {
  filenames <- list.files(paste("./synimg/train/", label, sep = ""), pattern = "*.jpg", full.names = TRUE)
  
  accum <- data.frame()
  
  results <- lapply(filenames, function(f) {
    img <- readJPEG(f)
    
    imgRgb <- getImageFeatures(label, img)
    
    rbind(accum, imgRgb)
  })

  results <- bind_rows(results)
}

splitTrainingAndValidationSets <- function(images) {
  list(images[1:3000,], images[3001:10000,])
}
```

```{r read-images}
cities <- list("Beijing", "Brisbane", "Geneva", "HongKong", "Luanda", "Melbourne", "Seoul", "Singapore", "Sydney", "Zurich")

training <- data.frame()
validation <- data.frame()

for (city in cities) {
  print(paste("reading", city))
  df <- extractAndLabelImages(city)
  tv <- splitTrainingAndValidationSets(df)
  
  training <- rbind(training, tv[[1]])
  validation <- rbind(validation, tv[[2]])
}

tree <- ctree(city ~ ., data = training)
save(tree, file = "cities.tree.model")

forest <- randomForest(city ~ ., data = training)
save(forest, file = "cities.forest.model")
```

```{r validation}
predict_cities <- function(method, model, data) {
  p <- predict(model, data)
  predicted <- cbind(p, data)

  correct <- predicted[predicted$p == predicted$city, ]
  print(paste(method, "% correct = ", nrow(correct) / nrow(predicted) * 100))
}

predict_cities("decision tree", tree, validation)
predict_cities("random forest", forest, validation)
```

```{r predict}

```